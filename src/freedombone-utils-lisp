#!/bin/bash
#
# .---.                  .              .
# |                      |              |
# |--- .--. .-.  .-.  .-.|  .-. .--.--. |.-.  .-. .--.  .-.
# |    |   (.-' (.-' (   | (   )|  |  | |   )(   )|  | (.-'
# '    '     --'  --'  -' -  -' '  '   -' -'   -' '   -  --'
#
#                    Freedom in the Cloud
#
# lisp functions
#
# License
# =======
#
# Copyright (C) 2016 Bob Mottram <bob@freedombone.net>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

COMMON_LISP_VERSION='1.11'

function install_common_lisp {
    # http://ccl.clozure.com
    if [ ! -d $INSTALL_DIR/lisp ]; then
        mkdir -p $INSTALL_DIR/lisp
    fi

    cd $INSTALL_DIR/lisp

    check_architecture=$(uname -a)
    if [[ "$check_architecture" == *"arm"* ]]; then
        svn co http://svn.clozure.com/publicsvn/openmcl/release/${COMMON_LISP_VERSION}/linuxarm/ccl
    else
        svn co http://svn.clozure.com/publicsvn/openmcl/release/${COMMON_LISP_VERSION}/linuxx86/ccl
    fi

    if [ ! -d $INSTALL_DIR/lisp/ccl/scripts ]; then
        echo $'Unable to clone ccl repo'
        exit 728245
    fi
    if [ ! -f $INSTALL_DIR/lisp/ccl/scripts/ccl ]; then
        echo $'ccl not found'
        exit 5825422
    fi
    cp $INSTALL_DIR/lisp/ccl/scripts/ccl /usr/bin
    if [ -f $INSTALL_DIR/lisp/ccl/scripts/ccl64 ]; then
        cp $INSTALL_DIR/lisp/ccl/scripts/ccl64 /usr/bin
    fi
}

function install_quicklisp {
    if [ ! -d $INSTALL_DIR/lisp ]; then
        mkdir -p $INSTALL_DIR/lisp
    fi
    cd $INSTALL_DIR/lisp
    if [ ! -f asdf.lisp ]; then
        wget https://common-lisp.net/project/asdf/asdf.lisp
    fi
    if [ ! -f asdf.lisp ]; then
        echo $'Unable to download asdf.lisp'
        exit 17529
    fi
    if [ ! -f quicklisp.lisp ]; then
        curl -O https://beta.quicklisp.org/quicklisp.lisp
    fi
    if [ ! -f quicklisp.lisp ]; then
        echo $'Unable to download quicklisp.lisp'
        exit 80253
    fi

    echo '(quicklisp-quickstart:install)' > install.lisp
    echo '(ql:add-to-init-file)' >> install.lisp
    echo '(load (compile-file "asdf.lisp"))' >> install.lisp

    check_architecture=$(uname -a)
    if [[ "$check_architecture" == *"64"* && "$check_architecture" != *"arm"* ]]; then
        ccl64 --load quicklisp.lisp
        ccl64 --load install.lisp
    else
        ccl --load quicklisp.lisp
        ccl --load install.lisp
    fi
}

# NOTE: deliberately no exit 0
